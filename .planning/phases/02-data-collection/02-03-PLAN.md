---
phase: 02-data-collection
plan: 03
type: execute
wave: 3
depends_on: ["02-01", "02-02"]
files_modified:
  - src/collectors/profiles.ts
  - src/collectors/index.ts
  - src/cli/index.ts
  - src/cli/options.ts
  - src/types/index.ts
autonomous: true

must_haves:
  truths:
    - "User sees contributors from all sources (commits, PRs, issues)"
    - "Large repos show all contributors (pagination completes)"
    - "User can filter to recent activity with --since flag"
    - "Progress bar shows collection progress with counts"
    - "Completion summary shows totals per source type"
    - "Ctrl+C saves partial data for resume"
  artifacts:
    - path: "src/collectors/profiles.ts"
      provides: "User profile fetching with cache"
      exports: ["ProfileFetcher", "fetchProfiles"]
    - path: "src/collectors/index.ts"
      provides: "Orchestrator running all collectors"
      exports: ["collectContributors", "CollectionResult"]
    - path: "src/cli/index.ts"
      provides: "CLI integration with --since flag and summary output"
      contains: "--since"
    - path: "src/cli/options.ts"
      provides: "Date parsing for --since flag"
      exports: ["parseSince"]
  key_links:
    - from: "src/collectors/index.ts"
      to: "src/collectors/commits.ts"
      via: "runs commit collector"
      pattern: "CommitCollector"
    - from: "src/collectors/index.ts"
      to: "src/collectors/pull-requests.ts"
      via: "runs PR collector"
      pattern: "PullRequestCollector"
    - from: "src/collectors/index.ts"
      to: "src/collectors/issues.ts"
      via: "runs issue collector"
      pattern: "IssueCollector"
    - from: "src/cli/index.ts"
      to: "src/collectors/index.ts"
      via: "calls collectContributors"
      pattern: "collectContributors"
---

<objective>
Wire all collectors together with an orchestrator, add profile fetching, integrate into CLI with --since flag, progress reporting, and graceful shutdown.

Purpose: Complete the data collection phase by connecting all components and providing user-facing feedback.
Output: Working CLI that collects all contributors from a repository with progress indication and summary output.
</objective>

<execution_context>
@/Users/jesse/.claude/get-shit-done/workflows/execute-plan.md
@/Users/jesse/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/02-data-collection/02-CONTEXT.md
@.planning/phases/02-data-collection/02-RESEARCH.md
@.planning/phases/02-data-collection/02-01-SUMMARY.md
@.planning/phases/02-data-collection/02-02-SUMMARY.md
@src/collectors/types.ts
@src/collectors/commits.ts
@src/collectors/pull-requests.ts
@src/collectors/issues.ts
@src/cli/index.ts
@src/cli/options.ts
@src/types/index.ts
@src/output/progress.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create profile fetcher and orchestrator</name>
  <files>
    src/collectors/profiles.ts
    src/collectors/index.ts
  </files>
  <action>
Create `src/collectors/profiles.ts`:
- Import cheerio, GitHubClient, types
- ProfileFetcher class
- Constructor takes GitHubClient instance
- fetchProfile(username: string): Promise<UserProfile>
  - Fetch `https://github.com/${username}`
  - Parse profile page for company field, bio, org memberships
  - Return { username, company, bio, orgs, fetchedAt }
  - Cache key should be `profile:${username}` (GitHubClient will cache)
- fetchProfiles(usernames: string[], onProgress?: (done: number, total: number) => void): Promise<Map<string, UserProfile>>
  - Batch fetch all profiles
  - Call onProgress callback for progress updates
  - Return map of username -> profile

Create `src/collectors/index.ts`:
- Import all collectors: CommitCollector, PullRequestCollector, IssueCollector
- Import ProfileFetcher
- Import types: ContributorActivity, mergeContributors

CollectionResult interface:
```typescript
interface CollectionResult {
  contributors: Map<string, ContributorActivity>;
  stats: {
    commits: number;
    prsAuthored: number;
    prsReviewed: number;
    issuesAuthored: number;
    issuesCommented: number;
    uniqueContributors: number;
  };
  aborted: boolean;
}
```

collectContributors function:
```typescript
async function collectContributors(
  client: GitHubClient,
  owner: string,
  repo: string,
  options: {
    since?: Date;
    onProgress?: (stage: string, current: number, total: number | null) => void;
    signal?: AbortSignal;
  }
): Promise<CollectionResult>
```

Implementation:
1. Create all collectors with client
2. Run CommitCollector: paginate until done or aborted, call onProgress('commits', ...)
3. Run PullRequestCollector (merged): paginate, call onProgress('prs', ...)
4. Run PullRequestCollector (open-active): same
5. Run IssueCollector: paginate, call onProgress('issues', ...)
6. Merge all contributor maps using mergeContributors
7. Fetch profiles for all unique contributors, call onProgress('profiles', ...)
8. Calculate stats from merged contributors
9. Return CollectionResult

Handle AbortSignal for graceful shutdown:
- Check signal.aborted before each fetch
- If aborted, return partial results with aborted: true
  </action>
  <verify>
```bash
npm run build
```
Build succeeds. collectContributors and CollectionResult are exported from src/collectors/index.ts.
  </verify>
  <done>
Orchestrator runs all collectors in sequence, merges results, fetches profiles, and supports abort for graceful shutdown.
  </done>
</task>

<task type="auto">
  <name>Task 2: Integrate into CLI with --since and progress</name>
  <files>
    src/cli/index.ts
    src/cli/options.ts
    src/types/index.ts
  </files>
  <action>
Update `src/cli/options.ts`:
- Add parseSince(value: string): Date function
  - Accept ISO date (2025-01-01), relative formats (12m, 6mo, 1y)
  - For relative: parse number + unit, use date-fns subMonths/subYears
  - Return Date object
  - Throw descriptive error if invalid format

Update `src/types/index.ts`:
- Add since?: Date to GitSneakOptions interface

Update `src/cli/index.ts`:
- Add --since option: .option('--since <date>', 'filter to activity after date (ISO or relative like 12m, 1y)', '12m')
- Parse --since using parseSince in action handler
- If no --since provided, default to 12 months per CONTEXT.md decision

Replace the placeholder fetch loop with real collection:
```typescript
// Old placeholder code:
// for (const repo of repos) {
//   const result = await client.fetch(repo.url);
//   ...
// }

// New collection code:
import { collectContributors } from '../collectors/index.js';

for (const repo of repos) {
  const abortController = new AbortController();

  // Handle SIGINT for graceful shutdown
  const sigintHandler = () => {
    abortController.abort();
  };
  process.on('SIGINT', sigintHandler);

  try {
    const result = await collectContributors(client, repo.owner, repo.repo, {
      since: options.since,
      onProgress: (stage, current, total) => {
        // Update progress bar
        progressBar.update(current, { status: `${stage}: ${current}${total ? '/' + total : ''}` });
      },
      signal: abortController.signal,
    });

    if (result.aborted) {
      logWarning('Collection interrupted. Partial data saved to cache.');
      break;
    }

    // Show completion summary
    logSuccess(`Found ${result.stats.uniqueContributors} contributors from ${result.stats.commits} commits, ${result.stats.prsAuthored} PRs, ${result.stats.issuesAuthored} issues`);

  } finally {
    process.removeListener('SIGINT', sigintHandler);
  }
}
```

Update progress bar creation to use MultiBar from cli-progress:
- Create bars for each stage: commits, prs, issues, profiles
- Show pattern: "Collecting commits... [=====>    ] 523/1200"
- In quiet mode, skip progress bars entirely

Add completion summary output:
```
Found 234 contributors:
  - 1,523 commits
  - 89 PRs (67 authored, 22 reviewed)
  - 156 issues (45 authored, 111 commented)
```
  </action>
  <verify>
```bash
npm run build
```
Build succeeds.

Manual test commands (executor should run):
```bash
# Test with default 12 months
node dist/index.js https://github.com/sindresorhus/is

# Test with explicit --since
node dist/index.js https://github.com/sindresorhus/is --since 6m

# Test verbose mode
node dist/index.js https://github.com/sindresorhus/is -v

# Test interrupt handling (Ctrl+C during collection)
node dist/index.js https://github.com/facebook/react
```
  </verify>
  <done>
CLI accepts --since flag (default 12m), shows progress bar with stage counts, displays completion summary with contributor totals by type, and gracefully handles Ctrl+C.
  </done>
</task>

<task type="auto">
  <name>Task 3: Add verbose logging and finalize</name>
  <files>
    src/collectors/index.ts
    src/collectors/commits.ts
    src/collectors/pull-requests.ts
    src/collectors/issues.ts
  </files>
  <action>
Add verbose logging throughout collectors per CONTEXT.md decision:
"Verbosity: Add -v flag for verbose mode (shows API calls, cache hits, pagination)"

Update each collector's collectPage method:
- Accept optional verbose flag or logger callback
- Log when fetching a page: "Fetching commits page 3..."
- Log cache hits: "Cache hit: /facebook/react/commits"
- Log pagination: "Found next page: ?after=abc123"

Update orchestrator (src/collectors/index.ts):
- Accept verbose option
- Pass to collectors
- Log stage transitions: "Starting commit collection..."
- Log stage completion: "Commits: 523 processed, 45 contributors found"

Ensure all collectors handle edge cases gracefully:
- Empty pages (no contributors on a page)
- Private repos (403 error - abort with message)
- Deleted users (skip gracefully)
- Malformed HTML (warn and continue)

Final verification: Run against a real repository and confirm:
1. Contributors are extracted from all sources
2. Progress shows during collection
3. Summary shows correct totals
4. Verbose mode shows API calls and cache status
5. Cache works (second run is faster)
  </action>
  <verify>
```bash
npm run build
```
Build succeeds.

Full integration test:
```bash
# First run - populates cache
node dist/index.js https://github.com/sindresorhus/is -v

# Second run - should show cache hits
node dist/index.js https://github.com/sindresorhus/is -v
```

Verify output includes:
- Progress indication during collection
- "Found X contributors from Y commits, Z PRs, W issues"
- In verbose mode: cache hit/miss logs
  </verify>
  <done>
Verbose mode shows API calls, cache hits, and pagination. All collectors handle edge cases gracefully. Full data collection pipeline works end-to-end.
  </done>
</task>

</tasks>

<verification>
After all tasks complete:
1. `npm run build` succeeds
2. `node dist/index.js https://github.com/sindresorhus/is --since 6m` completes successfully
3. Output shows contributor count and breakdown by source
4. Progress bar updates during collection
5. Verbose mode (-v) shows detailed logging
6. Cache hit on second run (faster execution)
7. Ctrl+C saves partial data and exits gracefully
</verification>

<success_criteria>
Phase 2 success criteria (from ROADMAP.md):
1. User sees contributors from commits, merged/active PRs, and issues - DONE via collectors
2. PR reviewers are captured alongside PR authors - DONE via PullRequestCollector
3. Issue commenters are captured alongside issue authors - DONE via IssueCollector
4. Large repositories with 100+ contributors show all results - DONE via pagination
5. User can filter to recent activity - DONE via --since flag

Additional criteria from CONTEXT.md:
- Progress bar with counts - DONE
- Verbose mode with API/cache logging - DONE
- Completion summary with totals - DONE
- Ctrl+C saves partial data - DONE via AbortSignal
</success_criteria>

<output>
After completion, create `.planning/phases/02-data-collection/02-03-SUMMARY.md`
</output>
