---
phase: 05-packaging-distribution
plan: 03
type: execute
wave: 2
depends_on: [05-01, 05-02]
files_modified:
  - support/homebrew-formula.rb
  - .github/workflows/release.yml
  - .github/workflows/ci.yml
autonomous: false

must_haves:
  truths:
    - "User can install via `brew install jesseops/gitsneak/gitsneak`"
    - "GitHub release triggers automatic formula update"
    - "CI runs tests on push"
  artifacts:
    - path: "support/homebrew-formula.rb"
      provides: "Homebrew formula template"
      contains: "class Gitsneak < Formula"
    - path: ".github/workflows/release.yml"
      provides: "Release automation"
      contains: "npm publish"
    - path: ".github/workflows/ci.yml"
      provides: "Continuous integration"
      contains: "npm run lint"
  key_links:
    - from: ".github/workflows/release.yml"
      to: "homebrew tap"
      via: "formula SHA update"
      pattern: "homebrew-gitsneak"

user_setup:
  - service: npm
    why: "Publish package to npm registry"
    env_vars:
      - name: NPM_TOKEN
        source: "npm.js -> Access Tokens -> Generate New Token (Automation)"
    secrets:
      - name: NPM_TOKEN
        location: "GitHub repo -> Settings -> Secrets -> Actions"
  - service: github
    why: "Update Homebrew tap repository"
    env_vars:
      - name: TAP_GITHUB_TOKEN
        source: "GitHub -> Settings -> Developer settings -> Personal access tokens -> Fine-grained -> Create (repo scope for homebrew-gitsneak)"
    secrets:
      - name: TAP_GITHUB_TOKEN
        location: "GitHub repo -> Settings -> Secrets -> Actions"
  - service: homebrew-tap
    why: "Host the formula"
    setup:
      - task: "Create repository homebrew-gitsneak"
        location: "GitHub -> New repository -> Name: homebrew-gitsneak"
      - task: "Create Formula/gitsneak.rb in tap repo"
        location: "After release workflow runs, or manually from support/homebrew-formula.rb"
---

<objective>
Homebrew tap with formula, GitHub Actions for CI and automated releases.

Purpose: Enable `brew install jesseops/gitsneak/gitsneak` without Node.js pre-installed. Automate the release pipeline so `just release 1.0.0` triggers npm publish and Homebrew formula update.

Output: Homebrew formula template, GitHub Actions workflows for CI and release automation.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/05-packaging-distribution/05-RESEARCH.md
@package.json
@justfile
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create Homebrew formula template</name>
  <files>support/homebrew-formula.rb</files>
  <action>
Create `support/homebrew-formula.rb` as a template for the Homebrew tap.

This is NOT placed in a tap repo yet - it's a reference that the release workflow will use to update the actual tap.

```ruby
# Homebrew formula for gitsneak
# Source: https://docs.brew.sh/Node-for-Formula-Authors
require "language/node"

class Gitsneak < Formula
  desc "Analyze organizational involvement in GitHub repositories"
  homepage "https://github.com/jesseops/gitsneak"
  url "https://registry.npmjs.org/gitsneak/-/gitsneak-VERSION.tgz"
  sha256 "SHA256_PLACEHOLDER"
  license "ISC"

  depends_on "node"
  # better-sqlite3 uses node-gyp which needs Python
  depends_on "python" => :build

  def install
    system "npm", "install", *std_npm_args
    bin.install_symlink libexec.glob("bin/*")

    # Install man page
    man1.install "man/gitsneak.1" if File.exist?("man/gitsneak.1")
  end

  test do
    assert_match version.to_s, shell_output("#{bin}/gitsneak --version")
  end
end
```

Key points from research:
- `depends_on "node"` required for native addon (better-sqlite3)
- `depends_on "python" => :build` for node-gyp compilation
- `std_npm_args` handles proper npm environment
- Man page installed if present
- Test verifies --version output

Note: VERSION and SHA256_PLACEHOLDER are replaced by release workflow.
  </action>
  <verify>File exists at support/homebrew-formula.rb with correct Ruby syntax</verify>
  <done>Formula template ready for tap repository</done>
</task>

<task type="auto">
  <name>Task 2: Create GitHub Actions CI workflow</name>
  <files>.github/workflows/ci.yml</files>
  <action>
Create `.github/workflows/ci.yml` for continuous integration on push/PR:

```yaml
name: CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: '22'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Lint
        run: npm run lint

      - name: Build
        run: npm run build

      - name: Build man page
        run: npm run build:man

      - name: Verify CLI works
        run: ./dist/index.js --version
```

This runs lint, build, man page generation, and a basic smoke test on every push.
  </action>
  <verify>File exists at .github/workflows/ci.yml with valid YAML</verify>
  <done>CI workflow runs on push and PR</done>
</task>

<task type="auto">
  <name>Task 3: Create GitHub Actions release workflow</name>
  <files>.github/workflows/release.yml</files>
  <action>
Create `.github/workflows/release.yml` for automated npm publish and Homebrew tap update:

```yaml
name: Release

on:
  push:
    tags:
      - 'v*'

jobs:
  publish:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: '22'
          registry-url: 'https://registry.npmjs.org'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Build
        run: npm run build

      - name: Build man page
        run: npm run build:man

      - name: Publish to npm
        run: npm publish
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}

  update-tap:
    needs: publish
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          repository: jesseops/homebrew-gitsneak
          token: ${{ secrets.TAP_GITHUB_TOKEN }}
          path: homebrew-tap

      - name: Update formula
        run: |
          VERSION="${GITHUB_REF#refs/tags/v}"
          TARBALL_URL="https://registry.npmjs.org/gitsneak/-/gitsneak-${VERSION}.tgz"

          # Wait for npm to propagate
          sleep 30

          # Download and calculate SHA256
          SHA256=$(curl -sL "$TARBALL_URL" | shasum -a 256 | cut -d' ' -f1)

          # Update formula
          cd homebrew-tap
          mkdir -p Formula

          # Copy template and substitute values
          sed -e "s|VERSION|${VERSION}|g" \
              -e "s|SHA256_PLACEHOLDER|${SHA256}|g" \
              ../support/homebrew-formula.rb > Formula/gitsneak.rb

          # Commit and push
          git config user.name "GitHub Actions"
          git config user.email "actions@github.com"
          git add Formula/gitsneak.rb
          git commit -m "gitsneak ${VERSION}"
          git push

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          generate_release_notes: true
```

This workflow:
1. Triggers on version tags (v1.0.0, v1.0.1, etc.)
2. Builds and publishes to npm
3. Updates the Homebrew tap with correct SHA256
4. Creates a GitHub release with auto-generated notes

User must:
1. Create `homebrew-gitsneak` repository on GitHub
2. Set NPM_TOKEN secret (npm automation token)
3. Set TAP_GITHUB_TOKEN secret (PAT with repo scope for homebrew-gitsneak)
  </action>
  <verify>File exists at .github/workflows/release.yml with valid YAML</verify>
  <done>Release workflow automates npm publish and Homebrew tap update</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>
Homebrew formula template, CI workflow, and release automation workflow.
  </what-built>
  <how-to-verify>
1. Review support/homebrew-formula.rb - valid Ruby syntax, correct dependencies
2. Review .github/workflows/ci.yml - valid YAML, sensible CI steps
3. Review .github/workflows/release.yml - valid YAML, correct npm/tap flow

Note: Actual testing requires:
- NPM_TOKEN secret configured
- TAP_GITHUB_TOKEN secret configured
- homebrew-gitsneak repository created on GitHub

These are documented in plan user_setup. Full end-to-end verification happens on first actual release.
  </how-to-verify>
  <resume-signal>Type "approved" if files look correct, or describe issues to fix</resume-signal>
</task>

</tasks>

<verification>
1. support/homebrew-formula.rb exists with valid Homebrew formula syntax
2. .github/workflows/ci.yml triggers on push, runs lint/build/test
3. .github/workflows/release.yml triggers on version tags, publishes to npm, updates tap
4. Human verification confirms correctness
</verification>

<success_criteria>
- DIST-01 satisfied: Homebrew tap formula ready (actual tap repo created by user)
- DIST-05 satisfied: Automated formula updates on GitHub release
- CI runs on every push
- Release workflow handles full publish + tap update pipeline
</success_criteria>

<output>
After completion, create `.planning/phases/05-packaging-distribution/05-03-SUMMARY.md`
</output>
