---
phase: 04-output-reporting
plan: 02
type: execute
wave: 2
depends_on: ["04-01"]
files_modified:
  - src/output/html-report.ts
  - src/reporting/index.ts
  - src/cli/index.ts
  - src/cli/options.ts
  - package.json
autonomous: false

must_haves:
  truths:
    - "User can pass --html flag to generate HTML report"
    - "HTML report opens automatically in default browser"
    - "Report contains interactive Chart.js bar chart of organization scores"
    - "Report shows same data as terminal table (organizations, scores, breakdowns)"
    - "HTML is self-contained (no external dependencies except CDN Chart.js)"
  artifacts:
    - path: "src/output/html-report.ts"
      provides: "HTML report generation with embedded Chart.js"
      exports: ["generateHtmlReport", "openReport"]
    - path: "src/cli/options.ts"
      provides: "--html flag parsing"
      contains: "html"
  key_links:
    - from: "src/cli/index.ts"
      to: "src/output/html-report.ts"
      via: "conditional call when --html flag set"
      pattern: "options\\.html.*generateHtmlReport"
    - from: "src/output/html-report.ts"
      to: "src/reporting/types.ts"
      via: "reads ReportData for template"
      pattern: "ReportData"
---

<objective>
Implement HTML report generation with interactive Chart.js visualization.

Purpose: Provide a richer, shareable report format that opens in browser with interactive charts for deeper exploration of organizational involvement data.

Output: `--html` flag generates self-contained HTML file with Chart.js bar chart and opens it in default browser.
</objective>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/04-output-reporting/04-RESEARCH.md
@.planning/phases/04-output-reporting/04-01-SUMMARY.md

# Types from Plan 01
@src/reporting/types.ts
@src/reporting/index.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: HTML report generator with Chart.js</name>
  <files>
    src/output/html-report.ts
    package.json
  </files>
  <action>
Install open package:
```bash
npm install open
```

Create `src/output/html-report.ts`:

Import open from 'open', writeFile from 'node:fs/promises', join from 'node:path', tmpdir from 'node:os', ReportData/OrganizationReport from '../reporting/types.js'.

Export `generateHtmlReport(report: ReportData): string`:

Use template literal to generate complete HTML document:
```html
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>GitSneak Report - ${report.repos.join(', ')}</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.5.0/dist/chart.umd.min.js"></script>
  <style>
    /* Embedded styles - modern, clean design */
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background: #f5f5f5; color: #333; line-height: 1.6; }
    .container { max-width: 1200px; margin: 0 auto; padding: 2rem; }
    header { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 2rem; border-radius: 8px; margin-bottom: 2rem; }
    h1 { font-size: 1.75rem; margin-bottom: 0.5rem; }
    .meta { opacity: 0.9; font-size: 0.9rem; }
    .card { background: white; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); padding: 1.5rem; margin-bottom: 1.5rem; }
    .card h2 { font-size: 1.25rem; margin-bottom: 1rem; color: #444; }
    .chart-container { position: relative; height: 400px; }
    table { width: 100%; border-collapse: collapse; }
    th, td { padding: 0.75rem; text-align: left; border-bottom: 1px solid #eee; }
    th { background: #f8f9fa; font-weight: 600; }
    tr:hover { background: #f8f9fa; }
    .rank { font-weight: 600; color: #667eea; }
    .score { font-weight: 600; }
    .unknown-section { opacity: 0.7; }
    .unknown-section th { background: #f0f0f0; }
    footer { text-align: center; padding: 1rem; color: #666; font-size: 0.85rem; }
  </style>
</head>
<body>
  <div class="container">
    <header>
      <h1>Organization Involvement Report</h1>
      <p class="meta">Repositories: ${report.repos.join(', ')}</p>
      <p class="meta">Generated: ${report.generatedAt.toLocaleString()}</p>
    </header>

    <div class="card">
      <h2>Top Organizations by Involvement Score</h2>
      <div class="chart-container">
        <canvas id="orgChart"></canvas>
      </div>
    </div>

    <div class="card">
      <h2>Organization Rankings</h2>
      <table>
        <thead>
          <tr>
            <th>Rank</th>
            <th>Organization</th>
            <th>Score</th>
            <th>Contributors</th>
            <th>Commits</th>
            <th>PRs (Authored/Reviewed)</th>
            <th>Issues (Authored/Comments)</th>
          </tr>
        </thead>
        <tbody>
          ${generateTableRows(report.organizations)}
        </tbody>
      </table>
      ${report.unknownContributors.length > 0 ? generateUnknownSection(report.unknownContributors) : ''}
    </div>

    <footer>
      Generated by GitSneak
    </footer>
  </div>

  <script>
    const ctx = document.getElementById('orgChart').getContext('2d');
    const topOrgs = ${JSON.stringify(report.organizations.slice(0, 15))};

    new Chart(ctx, {
      type: 'bar',
      data: {
        labels: topOrgs.map(o => o.name),
        datasets: [{
          label: 'Involvement Score',
          data: topOrgs.map(o => o.score),
          backgroundColor: 'rgba(102, 126, 234, 0.7)',
          borderColor: 'rgba(102, 126, 234, 1)',
          borderWidth: 1
        }]
      },
      options: {
        indexAxis: 'y',
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          legend: { display: false }
        },
        scales: {
          x: { beginAtZero: true, title: { display: true, text: 'Score' } }
        }
      }
    });
  </script>
</body>
</html>
```

Helper functions (inside the module, not exported):
- `generateTableRows(orgs: OrganizationReport[]): string` - Generate <tr> elements for each org
- `generateUnknownSection(unknown: ContributorScore[]): string` - Generate summary section for unaffiliated

Export `async function openReport(html: string): Promise<string>`:
1. Generate unique filename: `gitsneak-report-${Date.now()}.html`
2. Write to tmpdir: `const reportPath = join(tmpdir(), filename)`
3. await writeFile(reportPath, html, 'utf-8')
4. await open(reportPath)
5. Return reportPath (for logging)
  </action>
  <verify>
```bash
npx tsc --noEmit
```
Types compile without errors.
  </verify>
  <done>
- generateHtmlReport produces complete self-contained HTML
- HTML includes embedded CSS styling
- Chart.js loaded from CDN (v4.5.0)
- Horizontal bar chart shows top 15 organizations
- Table shows full organization data
- Unknown contributors shown in separate section
- openReport writes to temp and opens in browser
  </done>
</task>

<task type="auto">
  <name>Task 2: CLI --html flag integration</name>
  <files>
    src/cli/options.ts
    src/cli/index.ts
  </files>
  <action>
Modify `src/cli/options.ts`:
- Add to GitSneakOptions interface (if not in types/index.ts): `html?: boolean | string`
- Note: boolean for --html (temp file), string for --html path/to/report.html

Modify `src/cli/index.ts`:

1. Add --html option to commander:
```typescript
.option('--html [path]', 'generate HTML report (optionally specify output path)')
```

2. Parse html option in options object:
```typescript
html: opts.html, // boolean true if --html, string if --html path
```

3. Import generateHtmlReport, openReport from '../output/html-report.js'

4. After displayReport() call, add HTML report generation:
```typescript
if (options.html) {
  const html = generateHtmlReport(report);

  if (typeof options.html === 'string') {
    // Write to specified path
    await writeFile(options.html, html, 'utf-8');
    logSuccess(`HTML report written to ${options.html}`);
  } else {
    // Write to temp and open
    const reportPath = await openReport(html);
    logSuccess(`HTML report opened: ${reportPath}`);
  }
}
```

5. Add writeFile import from 'node:fs/promises' at top
  </action>
  <verify>
```bash
npm run build && ./dist/index.js https://github.com/sindresorhus/p-retry --since 6m --html
```
Should display terminal table, then open HTML report in browser.
  </verify>
  <done>
- --html flag accepted by CLI
- --html without path opens report in browser
- --html with path writes to specified location
- Success message shows report path
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>
Complete Phase 4 output and reporting system:
- Terminal ASCII table with organization rankings
- Weighted scoring algorithm
- Multi-repo aggregation
- HTML report with interactive Chart.js visualization
  </what-built>
  <how-to-verify>
1. **Test terminal output:**
```bash
./dist/index.js https://github.com/sindresorhus/p-retry --since 6m
```
Verify: ASCII table appears with ranked organizations, scores, and activity breakdowns

2. **Test HTML report:**
```bash
./dist/index.js https://github.com/sindresorhus/p-retry --since 6m --html
```
Verify: Browser opens with styled report containing:
- Header with repo name and timestamp
- Horizontal bar chart (Chart.js)
- Organization ranking table
- If any unaffiliated contributors, they appear in separate section

3. **Test multi-repo:**
```bash
./dist/index.js https://github.com/sindresorhus/p-retry https://github.com/sindresorhus/ky --since 6m --html
```
Verify: Combined results for both repos in single table and report

4. **Verify weighted scoring:**
Compare organizations - those with more PR activity should rank higher than issue-only orgs with similar raw counts
  </how-to-verify>
  <resume-signal>Type "approved" if all outputs look correct, or describe any issues with the table/report</resume-signal>
</task>

</tasks>

<verification>
After all tasks complete:

1. **Build succeeds:**
```bash
npm run build
```

2. **Terminal table displays:**
```bash
./dist/index.js https://github.com/sindresorhus/p-retry --since 6m
```

3. **HTML report generates and opens:**
```bash
./dist/index.js https://github.com/sindresorhus/p-retry --since 6m --html
```

4. **HTML to file works:**
```bash
./dist/index.js https://github.com/sindresorhus/p-retry --since 6m --html ./report.html
cat ./report.html | head -20
```

5. **Chart.js renders in browser:**
Open the HTML report and verify the bar chart is visible and interactive (hover shows tooltips)
</verification>

<success_criteria>
- OUT-02: HTML report with interactive visualizations (SATISFIED)
- Report opens in default browser automatically
- Chart.js bar chart renders correctly
- Report is self-contained (works offline except for CDN)
- Both terminal and HTML outputs work together
</success_criteria>

<output>
After completion, create `.planning/phases/04-output-reporting/04-02-SUMMARY.md`
</output>
