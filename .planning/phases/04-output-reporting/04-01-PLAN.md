---
phase: 04-output-reporting
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/reporting/types.ts
  - src/reporting/scorer.ts
  - src/reporting/aggregator.ts
  - src/output/table.ts
  - src/reporting/index.ts
  - src/cli/index.ts
  - package.json
autonomous: true

must_haves:
  truths:
    - "User sees terminal table ranking organizations by weighted involvement score"
    - "Rankings reflect activity weights (heavy contributors rank higher than drive-by participants)"
    - "Table shows breakdown by contribution type (commits, PRs authored, PRs reviewed, issues)"
    - "Unknown affiliations displayed separately, not competing in rankings"
    - "Multi-repo runs show aggregated results with contributor deduplication"
  artifacts:
    - path: "src/reporting/types.ts"
      provides: "OrganizationReport and ReportData types"
      exports: ["OrganizationReport", "ReportData", "ContributorScore"]
    - path: "src/reporting/scorer.ts"
      provides: "Weighted contribution scoring with diminishing returns"
      exports: ["calculateScore", "CONTRIBUTION_WEIGHTS"]
    - path: "src/reporting/aggregator.ts"
      provides: "Organization-centric aggregation from contributor data"
      exports: ["aggregateByOrganization", "aggregateMultiRepo"]
    - path: "src/output/table.ts"
      provides: "Terminal table rendering with cli-table3"
      exports: ["renderOrganizationTable"]
    - path: "src/reporting/index.ts"
      provides: "Report generation orchestrator"
      exports: ["generateReport"]
  key_links:
    - from: "src/cli/index.ts"
      to: "src/reporting/index.ts"
      via: "generateReport() call after collection"
      pattern: "generateReport.*CollectionResult"
    - from: "src/reporting/aggregator.ts"
      to: "src/collectors/types.ts"
      via: "reads ContributorActivity with affiliations"
      pattern: "ContributorActivity.*affiliations"
    - from: "src/output/table.ts"
      to: "src/reporting/types.ts"
      via: "renders OrganizationReport data"
      pattern: "OrganizationReport"
---

<objective>
Implement weighted scoring algorithm and ASCII table output for organization rankings.

Purpose: Transform raw contributor data into actionable business development intelligence with clear organization rankings displayed in the terminal.

Output: Terminal displays ranked organization table with scores, contributor counts, and activity breakdowns after each repository analysis.
</objective>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/04-output-reporting/04-RESEARCH.md

# Data structures from Phase 3
@src/collectors/types.ts
@src/collectors/index.ts
@src/organization/types.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Reporting types and weighted scorer</name>
  <files>
    src/reporting/types.ts
    src/reporting/scorer.ts
    package.json
  </files>
  <action>
Install cli-table3:
```bash
npm install cli-table3
```

Create `src/reporting/types.ts`:
- `ContributorScore`: username, score, breakdown counts
- `OrganizationReport`: name, score (weighted total), contributorCount, breakdown object (commits, prsAuthored, prsReviewed, issuesAuthored, issuesCommented), topContributors string[] (top 3 usernames by score)
- `ReportData`: organizations (OrganizationReport[]), unknownContributors (ContributorScore[]), repos string[], generatedAt Date

Create `src/reporting/scorer.ts`:
- Export `CONTRIBUTION_WEIGHTS` constant object:
  - commit: 1 (base unit)
  - prAuthored: 3 (most effort)
  - prReviewed: 2 (significant review effort)
  - issueAuthored: 1 (similar to commit)
  - issueCommented: 0.5 (lowest effort)
- Export `calculateScore(activity: ContributorActivity): number`:
  - Compute raw weighted sum from activity counts
  - Apply logarithmic scaling: `Math.log(raw + 1)` for diminishing returns
  - Return the scaled score
- Export `scoreContributor(activity: ContributorActivity): ContributorScore`:
  - Returns username, calculated score, and breakdown counts
  </action>
  <verify>
```bash
npx tsc --noEmit
```
Types compile without errors.
  </verify>
  <done>
- CONTRIBUTION_WEIGHTS defines activity weights (3/2/1/1/0.5)
- calculateScore returns logarithmically-scaled weighted score
- scoreContributor returns ContributorScore with breakdown
  </done>
</task>

<task type="auto">
  <name>Task 2: Organization aggregator and multi-repo support</name>
  <files>
    src/reporting/aggregator.ts
  </files>
  <action>
Create `src/reporting/aggregator.ts`:

Import ContributorActivity from collectors/types, OrganizationReport/ContributorScore from ./types, scorer functions.

Export `aggregateByOrganization(contributors: Map<string, ContributorActivity>): { organizations: OrganizationReport[]; unknown: ContributorScore[] }`:
1. Create orgMap: Map<string, { contributors: ContributorScore[]; breakdown: object }>
2. For each contributor:
   - Score the contributor using scoreContributor()
   - Get primaryOrg from activity (or "Unknown" if null/undefined)
   - If primaryOrg is null/undefined, add to unknown array, continue
   - If org not in orgMap, initialize with empty contributors array and zero breakdown
   - Add contributor score to org's contributors array
   - Sum breakdown counts into org's breakdown
3. Convert orgMap to OrganizationReport[]:
   - Sum contributor scores for org total score
   - Count contributors
   - Get top 3 contributors by score as topContributors
4. Sort organizations by score descending
5. Sort unknown by score descending
6. Return { organizations, unknown }

Export `aggregateMultiRepo(results: Array<{ repo: string; contributors: Map<string, ContributorActivity> }>): { contributors: Map<string, ContributorActivity>; repos: string[] }`:
1. Create allContributors Map
2. For each result:
   - For each contributor in result.contributors:
     - If username exists in allContributors, merge using mergeContributors logic (sum counts, merge emails, keep latest date, preserve affiliations from most recent)
     - Else add contributor to allContributors
3. Return { contributors: allContributors, repos: results.map(r => r.repo) }

Note: mergeContributors from collectors/types can be reused, but handle affiliations specially - keep the one with more affiliations or from the profile that was fetched.
  </action>
  <verify>
```bash
npx tsc --noEmit
```
Types compile. Aggregator exports both functions.
  </verify>
  <done>
- aggregateByOrganization transforms contributor Map to ranked OrganizationReport[]
- Unknown affiliations returned separately (not in rankings)
- aggregateMultiRepo deduplicates contributors by username across repos
- Organizations sorted by descending score
  </done>
</task>

<task type="auto">
  <name>Task 3: Terminal table renderer and CLI integration</name>
  <files>
    src/output/table.ts
    src/reporting/index.ts
    src/cli/index.ts
  </files>
  <action>
Create `src/output/table.ts`:

Import Table from 'cli-table3', pc from 'picocolors', OrganizationReport/ContributorScore from reporting/types.

Export `renderOrganizationTable(orgs: OrganizationReport[], unknown: ContributorScore[], options?: { limit?: number }): string`:
1. Default limit to 15 (top organizations)
2. Create Table with headers: Rank, Organization, Score, Contributors, Commits, PRs (A/R), Issues (A/C)
   - colWidths: [6, 25, 10, 12, 10, 12, 12]
   - Use pc.bold() for headers
3. Add rows for top N orgs:
   - Rank: 1, 2, 3... (color top 3 with pc.green, pc.cyan, pc.yellow)
   - Organization: name (truncate if >24 chars with ellipsis)
   - Score: formatted to 1 decimal place
   - Contributors: count
   - Commits: breakdown.commits
   - PRs (A/R): `${prsAuthored}/${prsReviewed}`
   - Issues (A/C): `${issuesAuthored}/${issuesCommented}`
4. If unknown.length > 0, add separator row and summary:
   - "(unaffiliated)" row showing total unknown count and their aggregate stats
5. Return table.toString()

Create `src/reporting/index.ts`:

Export `generateReport(results: CollectionResult | CollectionResult[], repos: string[]): ReportData`:
1. If single result, wrap in array
2. If multiple results, call aggregateMultiRepo to deduplicate contributors
3. Call aggregateByOrganization on merged contributors
4. Return ReportData with organizations, unknownContributors, repos, generatedAt: new Date()

Export `displayReport(report: ReportData, options: GitSneakOptions): void`:
1. Call renderOrganizationTable(report.organizations, report.unknownContributors)
2. console.log the table string
3. If verbose, log generatedAt timestamp

Modify `src/cli/index.ts`:
1. Import generateReport, displayReport from '../reporting/index.js'
2. After the repo processing loop (after all repos collected), add reporting phase:
   - Collect all CollectionResults into array (need to store them during loop)
   - Call generateReport with results array and repo names
   - Call displayReport with report and options
3. Store each successful CollectionResult in a results array during the loop
4. Only generate report if results.length > 0
  </action>
  <verify>
```bash
npm run build && ./dist/index.js https://github.com/sindresorhus/p-retry --since 12m
```
Should display ASCII table with organization rankings after collection completes.
  </verify>
  <done>
- Terminal shows organization ranking table after collection
- Top organizations ranked by weighted score
- Table shows contributor count and activity breakdown columns
- Unknown affiliations shown separately at bottom
- Multi-repo analysis aggregates and displays combined results
  </done>
</task>

</tasks>

<verification>
After all tasks complete:

1. **Build succeeds:**
```bash
npm run build
```

2. **Single repo analysis shows table:**
```bash
./dist/index.js https://github.com/sindresorhus/p-retry --since 6m
```
Expected: Collection runs, then ASCII table displays with ranked organizations

3. **Multi-repo analysis aggregates:**
```bash
./dist/index.js https://github.com/sindresorhus/p-retry https://github.com/sindresorhus/ky --since 6m
```
Expected: Both repos collected, single combined table shows aggregated results

4. **Weights visible in ranking:**
Heavy PR contributors should rank higher than issue-only participants with same raw activity count.
</verification>

<success_criteria>
- OUT-01: ASCII table displays organization rankings (SATISFIED)
- OUT-03: Weighted scoring implemented (SATISFIED)
- OUT-04: Multi-repo aggregation works (SATISFIED)
- OUT-05: Breakdown by contribution type in table columns (SATISFIED)
- Unknown affiliations handled separately (per research recommendation)
</success_criteria>

<output>
After completion, create `.planning/phases/04-output-reporting/04-01-SUMMARY.md`
</output>
