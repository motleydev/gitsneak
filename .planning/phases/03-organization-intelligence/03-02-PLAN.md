---
phase: 03-organization-intelligence
plan: 02
type: execute
wave: 2
depends_on: ["03-01"]
files_modified:
  - src/organization/confidence.ts
  - src/organization/case-insensitive-map.ts
  - src/organization/detector.ts
  - src/organization/index.ts
  - src/collectors/types.ts
  - src/collectors/index.ts
autonomous: true

must_haves:
  truths:
    - "User sees company affiliations extracted from GitHub profile company field"
    - "Public GitHub organization memberships are detected with HIGH confidence"
    - "Commit email domains provide fallback affiliation with MEDIUM confidence"
    - "Duplicate organizations are normalized (GOOGLE, Google, google merge into one)"
    - "Each affiliation shows a confidence indicator (HIGH/MEDIUM/LOW)"
    - "Contributors with no detection are grouped as Unknown"
  artifacts:
    - path: "src/organization/confidence.ts"
      provides: "Confidence level assignment logic"
      exports: ["assignConfidence", "compareConfidence"]
    - path: "src/organization/case-insensitive-map.ts"
      provides: "Case-insensitive Map for org deduplication"
      exports: ["CaseInsensitiveOrgMap"]
    - path: "src/organization/detector.ts"
      provides: "Main OrganizationDetector class"
      exports: ["OrganizationDetector"]
    - path: "src/organization/index.ts"
      provides: "Module barrel exports"
      exports: ["OrganizationDetector", "detectOrganizations"]
  key_links:
    - from: "src/organization/detector.ts"
      to: "src/organization/email-parser.ts"
      via: "import extractOrgFromEmail"
      pattern: "import.*extractOrgFromEmail.*from.*email-parser"
    - from: "src/organization/detector.ts"
      to: "src/organization/normalizer.ts"
      via: "import normalizeCompanyField"
      pattern: "import.*normalizeCompanyField.*from.*normalizer"
    - from: "src/organization/detector.ts"
      to: "src/organization/aliases.ts"
      via: "import resolveAlias"
      pattern: "import.*resolveAlias.*from.*aliases"
    - from: "src/collectors/index.ts"
      to: "src/organization/detector.ts"
      via: "detectOrganizations call in orchestrator"
      pattern: "detectOrganizations|OrganizationDetector"
---

<objective>
Create confidence scoring, case-insensitive deduplication, and the main OrganizationDetector that combines all detection methods.

Purpose: Complete the organization intelligence layer by assembling all signals (company, orgs, emails) into deduplicated OrganizationAffiliation results with proper confidence scoring.

Output: Working organization detection integrated with the data collection pipeline.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-organization-intelligence/03-CONTEXT.md
@.planning/phases/03-organization-intelligence/03-RESEARCH.md

# From Plan 01
@src/organization/types.ts
@src/organization/blocklist.ts
@src/organization/email-parser.ts
@src/organization/normalizer.ts
@src/organization/aliases.ts

# Integration targets
@src/collectors/types.ts
@src/collectors/profiles.ts
@src/collectors/index.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create confidence scoring and case-insensitive map</name>
  <files>
    - src/organization/confidence.ts
    - src/organization/case-insensitive-map.ts
  </files>
  <action>
1. Create src/organization/confidence.ts with:
   - assignConfidence(source: 'company' | 'org' | 'email'): ConfidenceLevel function
     - 'company' -> 'HIGH' (company field explicitly set)
     - 'org' -> 'HIGH' (public org membership = verified)
     - 'email' -> 'MEDIUM' (email domain match)
   - compareConfidence(a: ConfidenceLevel, b: ConfidenceLevel): number function
     - Returns positive if a > b, negative if a < b, 0 if equal
     - Order: HIGH > MEDIUM > LOW
   - higherConfidence(a: ConfidenceLevel, b: ConfidenceLevel): ConfidenceLevel function
     - Returns the higher of the two confidence levels

Per CONTEXT.md:
- HIGH: Company field explicitly set OR verified org membership
- MEDIUM: Email domain match (corporate) OR unconfirmed org membership
- LOW: Weak inference only (bio mentions, repo ownership patterns)
- When signals conflict, keep highest confidence

2. Create src/organization/case-insensitive-map.ts with:
   - CaseInsensitiveOrgMap<V> class extending Map<string, V>:
     - Private normalizeKey(key: string): string that lowercases and trims
     - Override set(key, value) to normalize key before storing
     - Override get(key) to normalize key before lookup
     - Override has(key) to normalize key before check
     - Override delete(key) to normalize key before delete
     - getCanonicalKey(key): string | undefined - returns the original casing of a stored key
       (store original casing in a parallel map for display purposes)

This ensures 'Google', 'GOOGLE', 'google' all merge into one entry per CONTEXT.md.
  </action>
  <verify>
    - npx tsc --noEmit passes
    - Manual test: CaseInsensitiveOrgMap merges 'Google' and 'GOOGLE' into same entry
  </verify>
  <done>Confidence scoring matches CONTEXT.md rules, case-insensitive map enables org deduplication</done>
</task>

<task type="auto">
  <name>Task 2: Create main OrganizationDetector</name>
  <files>
    - src/organization/detector.ts
    - src/organization/index.ts
  </files>
  <action>
1. Create src/organization/detector.ts with OrganizationDetector class:
   - Import extractOrgFromEmail from './email-parser.js'
   - Import normalizeCompanyField from './normalizer.js'
   - Import resolveAlias from './aliases.js'
   - Import assignConfidence, higherConfidence from './confidence.js'
   - Import CaseInsensitiveOrgMap from './case-insensitive-map.js'
   - Import UserProfile from '../collectors/profiles.js'
   - Import OrganizationSignal, OrganizationAffiliation, DetectionResult from './types.js'

   Constructor: (verbose: boolean = false)

   detectForContributor(profile: UserProfile, emails: Set<string>): DetectionResult method:
   a. Collect all signals (per CONTEXT.md: "Collect all signals first, then rank by confidence"):
      - If profile.company is set: normalize it, resolve alias, push signal with source='company', confidence='HIGH'
      - For each org in profile.orgs: resolve alias, push signal with source='org', confidence='HIGH'
      - For each email in emails: extract org, if not null, resolve alias, push signal with source='email', confidence='MEDIUM'

   b. Deduplicate signals using CaseInsensitiveOrgMap:
      - Key by lowercase org name
      - For each signal with same org: merge sources array, keep highest confidence

   c. Build affiliations array from deduplicated map:
      - Convert each entry to OrganizationAffiliation { name, confidence, sources }
      - Sort by confidence (HIGH first) then alphabetically

   d. Determine primaryOrg:
      - Prefer company field signal (if exists) as primary
      - Otherwise first HIGH confidence affiliation
      - Otherwise first affiliation
      - null if no affiliations

   e. Return DetectionResult { affiliations, primaryOrg }

   detectForContributors(profiles: Map<string, UserProfile>, activityMap: Map<string, ContributorActivity>): Map<string, DetectionResult>
   - For each profile, call detectForContributor with profile and activity.emails
   - Return map of username -> DetectionResult

2. Create src/organization/index.ts barrel export:
   - Export all types from './types.js'
   - Export { extractOrgFromEmail } from './email-parser.js'
   - Export { normalizeCompanyField } from './normalizer.js'
   - Export { resolveAlias, COMPANY_ALIASES } from './aliases.js'
   - Export { isBlockedDomain, BLOCKED_DOMAINS } from './blocklist.js'
   - Export { assignConfidence, compareConfidence, higherConfidence } from './confidence.js'
   - Export { CaseInsensitiveOrgMap } from './case-insensitive-map.js'
   - Export { OrganizationDetector } from './detector.js'
   - Export convenience function: detectOrganizations(profile, emails) that creates detector and calls detectForContributor

Per CONTEXT.md detection priority:
- Collect ALL signals first (not sequential short-circuit)
- Show all detected affiliations per contributor with their confidence levels
- For org-level rollup: count contributor fully toward each affiliated org
- 'Unknown' is valid category - contributors with no detection
  </action>
  <verify>
    - npx tsc --noEmit passes
    - npm run build succeeds
    - Manual test with mock data shows correct detection:
      - Profile with company='@Microsoft' -> affiliation 'Microsoft' HIGH
      - Profile with orgs=['facebook'] -> affiliation 'Meta' HIGH (alias resolved)
      - Emails with 'user@stripe.com' -> affiliation 'Stripe' MEDIUM
  </verify>
  <done>OrganizationDetector collects all signals, deduplicates case-insensitively, outputs affiliations sorted by confidence</done>
</task>

<task type="auto">
  <name>Task 3: Integrate with collector orchestrator</name>
  <files>
    - src/collectors/types.ts
    - src/collectors/index.ts
  </files>
  <action>
1. Update src/collectors/types.ts:
   - Import OrganizationAffiliation from '../organization/types.js'
   - Add to ContributorActivity interface:
     - affiliations?: OrganizationAffiliation[]
     - primaryOrg?: string | null

2. Update src/collectors/index.ts:
   - Import OrganizationDetector from '../organization/index.js'
   - After profile fetching in collectContributors, add organization detection step:
     a. Create detector = new OrganizationDetector(options.verbose)
     b. For each contributor in the result:
        - Get their profile from profiles map
        - Get their emails from ContributorActivity
        - Call detector.detectForContributor(profile, emails)
        - Assign result.affiliations and result.primaryOrg to ContributorActivity
     c. Add progress callback for 'organizations' stage if onProgress callback provided

   - Update CollectionResult type to include organization stats:
     - orgStats?: { withAffiliation: number, unknown: number }

3. Calculate and include org stats in the returned CollectionResult:
   - withAffiliation: count of contributors with at least one affiliation
   - unknown: count of contributors with no affiliations (will show as 'Unknown' per CONTEXT.md)

Per CONTEXT.md: 'Unknown' is a valid category - contributors with no detection grouped together
  </action>
  <verify>
    - npx tsc --noEmit passes
    - npm run build succeeds
    - Run CLI on a small repo: gitsneak https://github.com/sindresorhus/p-retry
    - Verify output shows contributor affiliations detected (some will have orgs, some Unknown)
  </verify>
  <done>Organization detection integrated into collection pipeline, contributors have affiliations and primaryOrg fields populated</done>
</task>

</tasks>

<verification>
After all tasks complete:
1. npm run build succeeds without errors
2. Run on test repo: gitsneak https://github.com/sindresorhus/p-retry
3. Check that:
   - Contributors with company fields show HIGH confidence affiliations
   - Contributors with org memberships show HIGH confidence affiliations
   - Contributors with corporate emails show MEDIUM confidence affiliations
   - Duplicate org names (different casing) are merged
   - Contributors without any signals have empty affiliations array
</verification>

<success_criteria>
- Company affiliations extracted from GitHub profile company field (ORG-01)
- Public GitHub organization memberships detected with HIGH confidence (ORG-02)
- Commit email domains provide fallback affiliation with MEDIUM confidence (ORG-03)
- Priority weighting applied: company field > org membership > email domain (ORG-04)
- Duplicate organizations normalized via case-insensitive matching (ORG-05)
- Confidence scores assigned to each affiliation (ORG-06)
- Contributors with no detection have empty affiliations (Unknown category)
</success_criteria>

<output>
After completion, create `.planning/phases/03-organization-intelligence/03-02-SUMMARY.md`
</output>
