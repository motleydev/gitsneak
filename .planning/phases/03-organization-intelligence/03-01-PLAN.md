---
phase: 03-organization-intelligence
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/organization/types.ts
  - src/organization/blocklist.ts
  - src/organization/email-parser.ts
  - src/organization/normalizer.ts
  - src/organization/aliases.ts
  - package.json
  - package-lock.json
autonomous: true

must_haves:
  truths:
    - "Email domains can be extracted from contributor email addresses"
    - "Free/privacy email providers are excluded from organization detection"
    - "Company field @ prefix is stripped during normalization"
    - "Legal suffixes (Inc, LLC, Ltd) are preserved during normalization"
    - "Major company rebrandings are mapped (Meta/Facebook, Alphabet/Google)"
  artifacts:
    - path: "src/organization/types.ts"
      provides: "OrganizationAffiliation, ConfidenceLevel, OrganizationSignal types"
      exports: ["OrganizationAffiliation", "ConfidenceLevel", "OrganizationSignal"]
    - path: "src/organization/blocklist.ts"
      provides: "Set of blocked email domains"
      exports: ["BLOCKED_DOMAINS", "isBlockedDomain"]
    - path: "src/organization/email-parser.ts"
      provides: "Email to organization name extraction"
      exports: ["extractOrgFromEmail"]
    - path: "src/organization/normalizer.ts"
      provides: "Company field normalization"
      exports: ["normalizeCompanyField"]
    - path: "src/organization/aliases.ts"
      provides: "Company alias mappings"
      exports: ["COMPANY_ALIASES", "resolveAlias"]
  key_links:
    - from: "src/organization/email-parser.ts"
      to: "src/organization/blocklist.ts"
      via: "import isBlockedDomain"
      pattern: "import.*isBlockedDomain.*from.*blocklist"
    - from: "src/organization/email-parser.ts"
      to: "tldts"
      via: "parse function for domain extraction"
      pattern: "import.*parse.*from.*tldts"
---

<objective>
Create organization detection foundation: types, email parsing with tldts, company normalization, and alias mappings.

Purpose: Establish the building blocks for converting raw contributor data (emails, company field, orgs) into normalized organization affiliations with confidence scores.

Output: src/organization/ directory with types, blocklist, email-parser, normalizer, and aliases modules.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-organization-intelligence/03-CONTEXT.md
@.planning/phases/03-organization-intelligence/03-RESEARCH.md

# Existing types to extend
@src/collectors/types.ts
@src/collectors/profiles.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install tldts and create organization types</name>
  <files>
    - package.json
    - package-lock.json
    - src/organization/types.ts
  </files>
  <action>
1. Install tldts library:
   ```bash
   npm install tldts
   ```

2. Create src/organization/types.ts with:
   - ConfidenceLevel type: 'HIGH' | 'MEDIUM' | 'LOW'
   - OrganizationSignal interface: { name: string, source: 'company' | 'org' | 'email', confidence: ConfidenceLevel }
   - OrganizationAffiliation interface: { name: string, confidence: ConfidenceLevel, sources: Array<'company' | 'org' | 'email'> }
   - DetectionResult interface: { affiliations: OrganizationAffiliation[], primaryOrg: string | null }

Per CONTEXT.md decisions:
- HIGH confidence: Company field explicitly set OR verified org membership
- MEDIUM confidence: Email domain match (corporate)
- LOW confidence: Weak inference only (bio mentions, repo ownership patterns)
  </action>
  <verify>
    - npm ls tldts shows version ^7.0.23 or compatible
    - npx tsc --noEmit passes without errors
  </verify>
  <done>tldts installed, organization types defined with confidence levels matching CONTEXT.md</done>
</task>

<task type="auto">
  <name>Task 2: Create blocklist and email parser</name>
  <files>
    - src/organization/blocklist.ts
    - src/organization/email-parser.ts
  </files>
  <action>
1. Create src/organization/blocklist.ts with:
   - BLOCKED_DOMAINS Set containing:
     - Free providers: gmail.com, googlemail.com, yahoo.com, yahoo.co.uk, ymail.com, hotmail.com, hotmail.co.uk, outlook.com, live.com, msn.com, aol.com, icloud.com, me.com, mac.com, mail.com, email.com, zoho.com, yandex.com, yandex.ru, mail.ru, fastmail.com, fastmail.fm, gmx.com, gmx.net
     - Privacy providers: protonmail.com, proton.me, tutanota.com, tutamail.com, pm.me
     - GitHub noreply: users.noreply.github.com
   - isBlockedDomain(domain: string): boolean function

2. Create src/organization/email-parser.ts with:
   - Import { parse } from 'tldts'
   - Import { isBlockedDomain } from './blocklist.js'
   - extractOrgFromEmail(email: string): string | null function that:
     a. Returns null if email is empty or has no @
     b. Extracts domain from email (everything after last @)
     c. Lowercases domain and checks blocklist - return null if blocked
     d. Uses tldts.parse() to get domainWithoutSuffix (handles subdomains correctly)
     e. Returns null if domainWithoutSuffix is falsy
     f. Capitalizes first letter: 'google' -> 'Google'

Per CONTEXT.md:
- 'user@cloud.google.com' should return 'Google' (root domain via tldts)
- 'user@stripe.com' should return 'Stripe'
- 'user@gmail.com' should return null (blocked)
  </action>
  <verify>
    - npx tsc --noEmit passes
    - Manual test in node REPL:
      ```
      import { extractOrgFromEmail } from './dist/organization/email-parser.js';
      extractOrgFromEmail('user@stripe.com') // should return 'Stripe'
      extractOrgFromEmail('user@gmail.com')  // should return null
      ```
  </verify>
  <done>Blocklist contains 25+ free/privacy domains, email parser extracts org names using tldts with proper subdomain handling</done>
</task>

<task type="auto">
  <name>Task 3: Create normalizer and alias mappings</name>
  <files>
    - src/organization/normalizer.ts
    - src/organization/aliases.ts
  </files>
  <action>
1. Create src/organization/normalizer.ts with:
   - normalizeCompanyField(company: string): string function that:
     a. Returns empty string if company is falsy
     b. Trims whitespace
     c. Strips leading @ only (per CONTEXT.md: '@google' -> 'google')
     d. Collapses multiple spaces to single space
     e. Does NOT strip legal suffixes (Inc, LLC, Ltd, GmbH, Corp) per CONTEXT.md

2. Create src/organization/aliases.ts with:
   - COMPANY_ALIASES Map<string, string> (lowercase key -> canonical name):
     - Meta family: facebook->Meta, instagram->Meta, whatsapp->Meta, oculus->Meta
     - Alphabet family: google->Alphabet, youtube->Alphabet, deepmind->Alphabet, waymo->Alphabet, verily->Alphabet
     - Other rebrandings: twitter->X, square->Block
     - Also include common variations: fb->Meta, googl->Alphabet
   - resolveAlias(orgName: string): string function that:
     a. Lowercases input and looks up in COMPANY_ALIASES
     b. Returns canonical name if found, otherwise returns original orgName unchanged

Per CONTEXT.md decisions:
- Keep legal suffixes (Inc, LLC, Ltd, GmbH, Corp) - do not strip
- Strip @ prefix only
- Ship built-in alias list for major company rebrandings
  </action>
  <verify>
    - npx tsc --noEmit passes
    - Manual test in node REPL:
      ```
      import { normalizeCompanyField } from './dist/organization/normalizer.js';
      normalizeCompanyField('@Microsoft')           // should return 'Microsoft'
      normalizeCompanyField('Google Inc')           // should return 'Google Inc' (keep suffix)
      normalizeCompanyField('  Some Company LLC  ') // should return 'Some Company LLC'
      ```
  </verify>
  <done>Normalizer strips @ prefix and preserves legal suffixes, alias map covers Meta/Alphabet/X/Block rebrandings</done>
</task>

</tasks>

<verification>
After all tasks complete:
1. Directory src/organization/ exists with 5 .ts files
2. npx tsc --noEmit passes with no errors
3. npm run build succeeds
4. tldts properly extracts root domains (verify 'cloud.google.com' -> 'google')
</verification>

<success_criteria>
- tldts installed as dependency
- All organization module types defined with exports
- Blocklist covers all free/privacy providers from CONTEXT.md
- Email parser handles subdomain extraction correctly via tldts
- Normalizer preserves legal suffixes, strips @ prefix
- Alias mappings cover major tech company rebrandings
</success_criteria>

<output>
After completion, create `.planning/phases/03-organization-intelligence/03-01-SUMMARY.md`
</output>
